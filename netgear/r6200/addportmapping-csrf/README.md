###Description###

This is a PoC CSRF targeting certain Netgear devices that forwards TCP port 5000 from the WAN interface to the router's internal IP address. This isn't original, but no one ever seems to acknowledge how common CSRF vulnerabilities are in UPnP services, so here's an example.

Here's [another](https://gist.github.com/phikshun/9632445) that predates mine.

The example in `addportmapping.html` exposes the router's UPnP service to the internet. Any vulnerabilities in the UPnP daemon may be exploited remotely from the internet. Further, you can add additional port mappings at will, without CSRF. For example you can add a port mapping to expose the router's web interface or its DLNA service.

This affects many models of Netgear routers, including the R6200 and R7000 (Nighthawk).

We basically shove the body of a SOAP request into the `<textarea>` of a form, and autosubmit the form on page load. Oh, and the form is in a hidden iframe, so you never see it.

There are a lot of problems in Netgear's UPnP daemon that make this possible:

- HTTP headers are sloppily parsed, if at all, and are not checked for a `SOAPAction` header.
- SOAP request parsing is a bunch of `strstr()`s across the entire blob read off the server's TCP socket. So as long as it contains something that _looks_ like a valid soap request, `upnpd` is happy.
- There is no good reason to forward ports to the router itself, but it happily does so if asked.

Here are some examples of LAN-only vulnerabilities that become fair-game:

- MiniDLNA [SQL injection/buffer overflow](https://vimeo.com/64809592) in WNDR3700v3
- Persistent [authentication bypass](http://shadow-file.blogspot.com/2013/10/complete-persistent-compromise-of.html) in WNDR3700v4
- MiniDLNA[SQL injection/buffer overflow](https://github.com/zcutlip/exploit-poc/tree/master/netgear/wndr3700v4/dlna_buffer_overflow) in WNDR3700v4
-Remote root access via [command injection](http://shadow-file.blogspot.com/2013/10/netgear-root-compromise-via-command.html) in WNDR3700v4
- MiniDLNA [SQL injection/buffer overflow](http://s3.amazonaws.com/zcutlip_storage/Cutlip_Infiltrate_2014_SQL_Injection_to_MIPS_Overflows_Part_Deux.pdf) (pdf) in WNDR3700 v3 (again).
- Persistent device takeover via [malicious firmware update](http://shadow-file.blogspot.com/2015/04/abandoned-part-01.html) in R6200.